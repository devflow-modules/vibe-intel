name: ðŸš€ Build Â· Test Â· Release Â· Deploy
run-name: "ðŸš€ Monorepo CI/CD â€” ${{ github.ref_name }}"

on:
  push:
    branches: ["main", "sprint/**"]
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  CI: true

jobs:
  setup:
    name: âš™ï¸ Setup Environment
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ§° Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: â™»ï¸ Cache PNPM Store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: âš¡ Cache Turbo Build
        uses: actions/cache@v4
        with:
          path: .turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('pnpm-lock.yaml') }}

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: âœ… Verify Workspace Integrity
        run: pnpm -r exec tsc --noEmit

  lint:
      name: ðŸ§¹ Lint
      runs-on: ubuntu-latest
      needs: setup

      steps:
        - uses: actions/checkout@v4
        - uses: pnpm/action-setup@v3
          with:
            version: 10
            run_install: false

        - name: â™»ï¸ Cache PNPM Store
          uses: actions/cache@v4
          with:
            path: ~/.pnpm-store
            key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
        - name: ðŸ§° Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: "22"
        - name: ðŸ“¦ Install Dependencies
          run: pnpm install --frozen-lockfile
        - name: âš™ï¸ Install Turborepo
          run: pnpm add -g turbo
        - name: ðŸ§¹ Run Lint
          run: pnpm exec turbo run lint

  test:
    name: ðŸ§ª Test
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: â™»ï¸ Cache PNPM Store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: âš™ï¸ Install Turborepo
        run: pnpm add -g turbo
      - name: ðŸ§ª Run Tests
        run: pnpm exec turbo run test

  build:
    name: ðŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [lint, test]

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: â™»ï¸ Cache PNPM Store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}
      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile
      - name: âš™ï¸ Install Turborepo
        run: pnpm add -g turbo
      - name: ðŸ—ï¸ Build All Packages
        run: pnpm exec turbo run build --filter=!./

  release:
    name: ðŸš€ Release Monorepo Packages
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    needs: [build]
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ§° Setup PNPM
        uses: pnpm/action-setup@v3
        with:
          version: 10
          run_install: false

      - name: â™»ï¸ Cache PNPM Store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: pnpm-${{ runner.os }}-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org/"
          scope: "@devflow-modules"
          always-auth: true

      - name: ðŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—ï¸ Build for Release
        run: pnpm build

      - name: ðŸš€ Semantic Release Monorepo
        run: pnpm release

      - name: ðŸ“„ Summary
        run: echo "ðŸŽ‰ Release concluÃ­do com sucesso!" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: ðŸŒ Deploy API to Railway
    runs-on: ubuntu-latest
    needs: [release]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref_name, 'sprint/')

    steps:
      - uses: actions/checkout@v4

      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: ðŸš€ Deploy to Railway
        uses: railwayapp/github-action@v3
        with:
          railwayToken: ${{ secrets.RAILWAY_TOKEN }}
          service: "vibe-api"
          environment: ${{ startsWith(github.ref_name, 'sprint/') && 'staging' || 'production' }}

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: ðŸ§¾ Tail Logs (Pino + OpenTelemetry)
        if: success()
        run: |
          echo "ðŸ“¡ Capturando logs da aplicaÃ§Ã£o..."
          railway logs --service vibe-api --lines 100 --token ${{ secrets.RAILWAY_TOKEN }}

      - name: ðŸ“„ Summary
        run: echo "ðŸŒ Deploy realizado com sucesso no ambiente ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
